(function(){var e,t,n,i,o,r,a,s,l,u,c,d,h,f,p,m,g,v,y,b,w,x,C,k,T=[].slice,E=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};e=window.jQuery||window.Zepto||window.$,e.payment={},e.payment.fn={},e.fn.payment=function(){var t,n;return n=arguments[0],t=2<=arguments.length?T.call(arguments,1):[],e.payment.fn[n].apply(this,t)},o=/(\d{1,4})/g,e.payment.cards=i=[{type:"visaelectron",pattern:/^4(026|17500|405|508|844|91[37])/,format:o,length:[16],cvcLength:[3],luhn:!0},{type:"maestro",pattern:/^(5(018|0[23]|[68])|6(39|7))/,format:o,length:[12,13,14,15,16,17,18,19],cvcLength:[3],luhn:!0},{type:"forbrugsforeningen",pattern:/^600/,format:o,length:[16],cvcLength:[3],luhn:!0},{type:"dankort",pattern:/^5019/,format:o,length:[16],cvcLength:[3],luhn:!0},{type:"visa",pattern:/^4/,format:o,length:[13,16],cvcLength:[3],luhn:!0},{type:"mastercard",pattern:/^(5[1-5]|2[2-7])/,format:o,length:[16],cvcLength:[3],luhn:!0},{type:"amex",pattern:/^3[47]/,format:/(\d{1,4})(\d{1,6})?(\d{1,5})?/,length:[15],cvcLength:[3,4],luhn:!0},{type:"dinersclub",pattern:/^3[0689]/,format:/(\d{1,4})(\d{1,6})?(\d{1,4})?/,length:[14],cvcLength:[3],luhn:!0},{type:"discover",pattern:/^6([045]|22)/,format:o,length:[16],cvcLength:[3],luhn:!0},{type:"unionpay",pattern:/^(62|88)/,format:o,length:[16,17,18,19],cvcLength:[3],luhn:!1},{type:"jcb",pattern:/^35/,format:o,length:[16],cvcLength:[3],luhn:!0}],t=function(e){var t,n,o;for(e=(e+"").replace(/\D/g,""),n=0,o=i.length;o>n;n++)if(t=i[n],t.pattern.test(e))return t},n=function(e){var t,n,o;for(n=0,o=i.length;o>n;n++)if(t=i[n],t.type===e)return t},h=function(e){var t,n,i,o,r,a;for(i=!0,o=0,n=(e+"").split("").reverse(),r=0,a=n.length;a>r;r++)t=n[r],t=parseInt(t,10),(i=!i)&&(t*=2),t>9&&(t-=9),o+=t;return o%10===0},d=function(e){var t;return null!=e.prop("selectionStart")&&e.prop("selectionStart")!==e.prop("selectionEnd")?!0:null!=("undefined"!=typeof document&&null!==document&&null!=(t=document.selection)?t.createRange:void 0)&&document.selection.createRange().text?!0:!1},C=function(e,t){var n,i,o;try{n=t.prop("selectionStart")}catch(r){i=r,n=null}return o=t.val(),t.val(e),null!==n&&t.is(":focus")?(n===o.length&&(n=e.length),t.prop("selectionStart",n),t.prop("selectionEnd",n)):void 0},v=function(e){var t,n,i,o,r,a,s,l;for(null==e&&(e=""),i="\uff10\uff11\uff12\uff13\uff14\uff15\uff16\uff17\uff18\uff19",o="0123456789",a="",n=e.split(""),s=0,l=n.length;l>s;s++)t=n[s],r=i.indexOf(t),r>-1&&(t=o[r]),a+=t;return a},g=function(t){return setTimeout(function(){var n,i;return n=e(t.currentTarget),i=n.val(),i=v(i),i=i.replace(/\D/g,""),C(i,n)})},p=function(t){return setTimeout(function(){var n,i;return n=e(t.currentTarget),i=n.val(),i=v(i),i=e.payment.formatCardNumber(i),C(i,n)})},s=function(n){var i,o,r,a,s,l,u;return r=String.fromCharCode(n.which),!/^\d+$/.test(r)||(i=e(n.currentTarget),u=i.val(),o=t(u+r),a=(u.replace(/\D/g,"")+r).length,l=16,o&&(l=o.length[o.length.length-1]),a>=l||null!=i.prop("selectionStart")&&i.prop("selectionStart")!==u.length)?void 0:(s=o&&"amex"===o.type?/^(\d{4}|\d{4}\s\d{6})$/:/(?:^|\s)(\d{4})$/,s.test(u)?(n.preventDefault(),setTimeout(function(){return i.val(u+" "+r)})):s.test(u+r)?(n.preventDefault(),setTimeout(function(){return i.val(u+r+" ")})):void 0)},r=function(t){var n,i;return n=e(t.currentTarget),i=n.val(),8!==t.which||null!=n.prop("selectionStart")&&n.prop("selectionStart")!==i.length?void 0:/\d\s$/.test(i)?(t.preventDefault(),setTimeout(function(){return n.val(i.replace(/\d\s$/,""))})):/\s\d?$/.test(i)?(t.preventDefault(),setTimeout(function(){return n.val(i.replace(/\d$/,""))})):void 0},m=function(t){return setTimeout(function(){var n,i;return n=e(t.currentTarget),i=n.val(),i=v(i),i=e.payment.formatExpiry(i),C(i,n)})},l=function(t){var n,i,o;return i=String.fromCharCode(t.which),/^\d+$/.test(i)?(n=e(t.currentTarget),o=n.val()+i,/^\d$/.test(o)&&"0"!==o&&"1"!==o?(t.preventDefault(),setTimeout(function(){return n.val("0"+o+" / ")})):/^\d\d$/.test(o)?(t.preventDefault(),setTimeout(function(){return n.val(""+o+" / ")})):void 0):void 0},u=function(t){var n,i,o;return i=String.fromCharCode(t.which),/^\d+$/.test(i)?(n=e(t.currentTarget),o=n.val(),/^\d\d$/.test(o)?n.val(""+o+" / "):void 0):void 0},c=function(t){var n,i,o;return o=String.fromCharCode(t.which),"/"===o||" "===o?(n=e(t.currentTarget),i=n.val(),/^\d$/.test(i)&&"0"!==i?n.val("0"+i+" / "):void 0):void 0},a=function(t){var n,i;return n=e(t.currentTarget),i=n.val(),8!==t.which||null!=n.prop("selectionStart")&&n.prop("selectionStart")!==i.length?void 0:/\d\s\/\s$/.test(i)?(t.preventDefault(),setTimeout(function(){return n.val(i.replace(/\d\s\/\s$/,""))})):void 0},f=function(t){return setTimeout(function(){var n,i;return n=e(t.currentTarget),i=n.val(),i=v(i),i=i.replace(/\D/g,"").slice(0,4),C(i,n)})},x=function(e){var t;return e.metaKey||e.ctrlKey?!0:32===e.which?!1:0===e.which?!0:e.which<33?!0:(t=String.fromCharCode(e.which),!!/[\d\s]/.test(t))},b=function(n){var i,o,r,a;return i=e(n.currentTarget),r=String.fromCharCode(n.which),/^\d+$/.test(r)&&!d(i)?(a=(i.val()+r).replace(/\D/g,""),o=t(a),o?a.length<=o.length[o.length.length-1]:a.length<=16):void 0},w=function(t){var n,i,o;return n=e(t.currentTarget),i=String.fromCharCode(t.which),/^\d+$/.test(i)&&!d(n)?(o=n.val()+i,o=o.replace(/\D/g,""),o.length>6?!1:void 0):void 0},y=function(t){var n,i,o;return n=e(t.currentTarget),i=String.fromCharCode(t.which),/^\d+$/.test(i)&&!d(n)?(o=n.val()+i,o.length<=4):void 0},k=function(t){var n,o,r,a,s;return n=e(t.currentTarget),s=n.val(),a=e.payment.cardType(s)||"unknown",n.hasClass(a)?void 0:(o=function(){var e,t,n;for(n=[],e=0,t=i.length;t>e;e++)r=i[e],n.push(r.type);return n}(),n.removeClass("unknown"),n.removeClass(o.join(" ")),n.addClass(a),n.toggleClass("identified","unknown"!==a),n.trigger("payment.cardType",a))},e.payment.fn.formatCardCVC=function(){return this.on("keypress",x),this.on("keypress",y),this.on("paste",f),this.on("change",f),this.on("input",f),this},e.payment.fn.formatCardExpiry=function(){return this.on("keypress",x),this.on("keypress",w),this.on("keypress",l),this.on("keypress",c),this.on("keypress",u),this.on("keydown",a),this.on("change",m),this.on("input",m),this},e.payment.fn.formatCardNumber=function(){return this.on("keypress",x),this.on("keypress",b),this.on("keypress",s),this.on("keydown",r),this.on("keyup",k),this.on("paste",p),this.on("change",p),this.on("input",p),this.on("input",k),this},e.payment.fn.restrictNumeric=function(){return this.on("keypress",x),this.on("paste",g),this.on("change",g),this.on("input",g),this},e.payment.fn.cardExpiryVal=function(){return e.payment.cardExpiryVal(e(this).val())},e.payment.cardExpiryVal=function(e){var t,n,i,o;return o=e.split(/[\s\/]+/,2),t=o[0],i=o[1],2===(null!=i?i.length:void 0)&&/^\d+$/.test(i)&&(n=(new Date).getFullYear(),n=n.toString().slice(0,2),i=n+i),t=parseInt(t,10),i=parseInt(i,10),{month:t,year:i}},e.payment.validateCardNumber=function(e){var n,i;return e=(e+"").replace(/\s+|-/g,""),/^\d+$/.test(e)?(n=t(e),n?(i=e.length,E.call(n.length,i)>=0&&(n.luhn===!1||h(e))):!1):!1},e.payment.validateCardExpiry=function(t,n){var i,o,r;return"object"==typeof t&&"month"in t&&(r=t,t=r.month,n=r.year),t&&n?(t=e.trim(t),n=e.trim(n),/^\d+$/.test(t)&&/^\d+$/.test(n)&&t>=1&&12>=t?(2===n.length&&(n=70>n?"20"+n:"19"+n),4!==n.length?!1:(o=new Date(n,t),i=new Date,o.setMonth(o.getMonth()-1),o.setMonth(o.getMonth()+1,1),o>i)):!1):!1},e.payment.validateCardCVC=function(t,i){var o,r;return t=e.trim(t),/^\d+$/.test(t)?(o=n(i),null!=o?(r=t.length,E.call(o.cvcLength,r)>=0):t.length>=3&&t.length<=4):!1},e.payment.cardType=function(e){var n;return e?(null!=(n=t(e))?n.type:void 0)||null:null},e.payment.formatCardNumber=function(n){var i,o,r,a;return n=n.replace(/\D/g,""),(i=t(n))?(r=i.length[i.length.length-1],n=n.slice(0,r),i.format.global?null!=(a=n.match(i.format))?a.join(" "):void 0:(o=i.format.exec(n),null!=o?(o.shift(),o=e.grep(o,function(e){return e}),o.join(" ")):void 0)):n},e.payment.formatExpiry=function(e){var t,n,i,o;return(n=e.match(/^\D*(\d{1,2})(\D+)?(\d{1,4})?/))?(t=n[1]||"",i=n[2]||"",o=n[3]||"",o.length>0?i=" / ":" /"===i?(t=t.substring(0,1),i=""):2===t.length||i.length>0?i=" / ":1===t.length&&"0"!==t&&"1"!==t&&(t="0"+t,i=" / "),t+i+o):""}}).call(this),function(){null==CakeCouponBook.validations&&(CakeCouponBook.validations={}),CakeCouponBook.validations.customMethods=function(){$.validator.addMethod("onlyletters",function(e,t){return this.optional(t)||/^[a-z\s]+$/i.test(e)},function(){return"Please enter only letters."}),$.validator.addMethod("url",function(e,t){return this.optional(t)||/^(?:(?:https?|ftp):\/\/)?(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/\S*)?$/i.test(e)},function(){return"Please enter a valid URL."}),$.validator.addMethod("minStrictPledgeLevels",function(e,t){var n;return n=$(t).closest(".pledge_level").find(".min_value").text().replace("$","").replace(",",""),this.optional(t)||parseInt(e)>parseInt(n)},function(e,t){var n;return n=$(t).closest(".pledge_level").find(".min_value").text().replace("$",""),"Please enter a value greater than $"+n}),$.validator.addMethod("limitToIntegerRange",function(e,t){return this.optional(t)||parseInt(e)<9999999999},function(){return"Please enter a value smaller than $9999999999"}),$.validator.addMethod("minStrict",function(e,t,n){return this.optional(t)||parseInt(e)>parseInt(n)},jQuery.validator.format("Please enter a value greater than {0}")),$.validator.addMethod("minCurrency",function(e,t,n){return this.optional(t)||parseInt(e)>=parseInt(n)},jQuery.validator.format("Please enter a value greater than ${0}")),$.validator.addMethod("firstLastName",function(e,t){return this.optional(t)||/^\w+\s+\w+$/i.test(e)},function(){return"Please enter First and Last Name."}),$.validator.addMethod("creditcard",function(e,t){return this.optional(t)||$.payment.validateCardNumber(e)},function(){return"Please enter a valid Card Number."}),$.validator.addMethod("cvc",function(e,t,n){var i;return i=$.payment.cardType($(n).val()),this.optional(t)||$.payment.validateCardCVC(e,i)},function(){return"The CVC number is incorrect."})}}.call(this),function(){var e,t;null==CakeCouponBook.purchases&&(CakeCouponBook.purchases={}),t=function(){function e(e){this.loadScript(e)}return e.prototype.loadScript=function(e){var t,n;void 0===window.Stripe&&(n=document.createElement("script"),n.async=!0,n.src="https://js.stripe.com/v2/",n.type="text/javascript",n.onreadystatechange=function(){"complete"===this.readyState&&window.Stripe.setPublishableKey(e)},n.onload=function(){window.Stripe.setPublishableKey(e)},t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(n,t))},e}(),e=function(){function e(e,n,i){this.form=$(e),this.cardNumber=this.form.find("input#purchase_card_number"),this.expMonth=this.form.find("input#purchase_exp_month"),this.expYear=this.form.find("input#purchase_exp_year"),this.cvc=this.form.find("input#purchase_cvc"),this.cardLogos=this.form.find(".cards"),this.submitButton=this.form.find('input[type="submit"]'),this.cardTokenInput=this.form.find("input#purchase_card_token_input"),this.amount=n,this.stripeKey=i,this.stripe=new t(i),this.spinner=$("#overlay_loading"),this.setUp(),this.onSubmit()}return e.prototype.setUp=function(){$('[data-toggle="tooltip"]').tooltip(),CakeCouponBook.validations.customMethods(),this.validation(),this.formSetup()},e.prototype.formSetup=function(){this.cardNumber.payment("formatCardNumber"),this.cvc.payment("formatCardCVC"),this.form.find(".restrictToNumber").payment("restrictNumeric"),this.showCardLogo()},e.prototype.showCardLogo=function(){var e;e=this,this.cardNumber.keyup(function(){var t;t=$.payment.cardType(this.value),null===t?e.cardLogos.removeClass().addClass("cards"):e.cardLogos.removeClass().addClass("cards").addClass(t)})},e.prototype.onSubmit=function(){var e;e=this,this.submitButton.click(function(t){e.form.valid()&&(t.preventDefault(),e.disableForm(),e.createToken())})},e.prototype.createToken=function(){var e,n;n=this,void 0===window.Stripe&&new t(this.stripeKey),e={number:this.cardNumber.val().replace(/\s+/g,""),exp_month:this.expMonth.val(),exp_year:this.expYear.val(),cvc:this.cvc.val()},window.Stripe.card.createToken(e,function(e,t){var i;t.error?(n.form.find("#payment-errors").text(t.error.message).removeClass("hidden"),n.enableForm()):(i=t.id,n.cardTokenInput.val(i),n.removeInputNames(),n.form.get(0).submit())})},e.prototype.enableForm=function(){this.submitButton.prop("disabled",!1),this.form.find("fieldset").css("opacity",1),this.spinner.addClass("hidden")},e.prototype.disableForm=function(){this.submitButton.prop("disabled",!0),this.form.find("fieldset").css("opacity",.5),this.spinner.removeClass("hidden")},e.prototype.removeInputNames=function(){var e;e=this.form.find(".cc_inputs input"),e.each(function(){$(this).removeAttr("name")})},e.prototype.validation=function(){var e;e=this,this.form.validate({errorElement:"span",rules:{"purchase[amount]":{required:!0,minCurrency:e.amount},"purchase[first_name]":{required:!0,onlyletters:!0},"purchase[last_name]":{required:!0,onlyletters:!0},"purchase[zip_code]":{required:!0,minlength:5,maxlength:5},"purchase[email]":{required:!0},"purchase[email_confirmation]":{required:!0,equalTo:"#purchase_email"},"purchase[card_number]":{required:!0,creditcard:!0},"purchase[exp_month]":{required:!0,digits:!0,maxlength:2,range:[1,12]},"purchase[exp_year]":{required:!0,digits:!0,maxlength:2,range:[15,99]},"purchase[cvc]":{required:!0,cvc:"#purchase_card_number"},"purchase[gift_attributes][first_name]":{required:"#gift-checkbox:checked"},"purchase[gift_attributes][last_name]":{required:"#gift-checkbox:checked"},"purchase[gift_attributes][email]":{required:"#gift-checkbox:checked"},"purchase[gift_attributes][email_confirmation]":{required:"#gift-checkbox:checked",equalTo:"#purchase_gift_attributes_email"}}})},e}(),CakeCouponBook.purchases.coupon_book=function(t,n){new e(".formtastic.purchase",t,n)}}.call(this);