(function(){var t,e,n,r,a,i,o,s,u,c,l,h,d,p,f,m,v,g,y,C,$,b,k,w,T=[].slice,_=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};t=window.jQuery||window.Zepto||window.$,t.payment={},t.payment.fn={},t.fn.payment=function(){var e,n;return n=arguments[0],e=2<=arguments.length?T.call(arguments,1):[],t.payment.fn[n].apply(this,e)},a=/(\d{1,4})/g,t.payment.cards=r=[{type:"visaelectron",pattern:/^4(026|17500|405|508|844|91[37])/,format:a,length:[16],cvcLength:[3],luhn:!0},{type:"maestro",pattern:/^(5(018|0[23]|[68])|6(39|7))/,format:a,length:[12,13,14,15,16,17,18,19],cvcLength:[3],luhn:!0},{type:"forbrugsforeningen",pattern:/^600/,format:a,length:[16],cvcLength:[3],luhn:!0},{type:"dankort",pattern:/^5019/,format:a,length:[16],cvcLength:[3],luhn:!0},{type:"visa",pattern:/^4/,format:a,length:[13,16],cvcLength:[3],luhn:!0},{type:"mastercard",pattern:/^(5[1-5]|2[2-7])/,format:a,length:[16],cvcLength:[3],luhn:!0},{type:"amex",pattern:/^3[47]/,format:/(\d{1,4})(\d{1,6})?(\d{1,5})?/,length:[15],cvcLength:[3,4],luhn:!0},{type:"dinersclub",pattern:/^3[0689]/,format:/(\d{1,4})(\d{1,6})?(\d{1,4})?/,length:[14],cvcLength:[3],luhn:!0},{type:"discover",pattern:/^6([045]|22)/,format:a,length:[16],cvcLength:[3],luhn:!0},{type:"unionpay",pattern:/^(62|88)/,format:a,length:[16,17,18,19],cvcLength:[3],luhn:!1},{type:"jcb",pattern:/^35/,format:a,length:[16],cvcLength:[3],luhn:!0}],e=function(t){var e,n,a;for(t=(t+"").replace(/\D/g,""),n=0,a=r.length;a>n;n++)if(e=r[n],e.pattern.test(t))return e},n=function(t){var e,n,a;for(n=0,a=r.length;a>n;n++)if(e=r[n],e.type===t)return e},d=function(t){var e,n,r,a,i,o;for(r=!0,a=0,n=(t+"").split("").reverse(),i=0,o=n.length;o>i;i++)e=n[i],e=parseInt(e,10),(r=!r)&&(e*=2),e>9&&(e-=9),a+=e;return a%10===0},h=function(t){var e;return null!=t.prop("selectionStart")&&t.prop("selectionStart")!==t.prop("selectionEnd")?!0:null!=("undefined"!=typeof document&&null!==document&&null!=(e=document.selection)?e.createRange:void 0)&&document.selection.createRange().text?!0:!1},k=function(t,e){var n,r,a;try{n=e.prop("selectionStart")}catch(i){r=i,n=null}return a=e.val(),e.val(t),null!==n&&e.is(":focus")?(n===a.length&&(n=t.length),e.prop("selectionStart",n),e.prop("selectionEnd",n)):void 0},g=function(t){var e,n,r,a,i,o,s,u;for(null==t&&(t=""),r="\uff10\uff11\uff12\uff13\uff14\uff15\uff16\uff17\uff18\uff19",a="0123456789",o="",n=t.split(""),s=0,u=n.length;u>s;s++)e=n[s],i=r.indexOf(e),i>-1&&(e=a[i]),o+=e;return o},v=function(e){return setTimeout(function(){var n,r;return n=t(e.currentTarget),r=n.val(),r=g(r),r=r.replace(/\D/g,""),k(r,n)})},f=function(e){return setTimeout(function(){var n,r;return n=t(e.currentTarget),r=n.val(),r=g(r),r=t.payment.formatCardNumber(r),k(r,n)})},s=function(n){var r,a,i,o,s,u,c;return i=String.fromCharCode(n.which),!/^\d+$/.test(i)||(r=t(n.currentTarget),c=r.val(),a=e(c+i),o=(c.replace(/\D/g,"")+i).length,u=16,a&&(u=a.length[a.length.length-1]),o>=u||null!=r.prop("selectionStart")&&r.prop("selectionStart")!==c.length)?void 0:(s=a&&"amex"===a.type?/^(\d{4}|\d{4}\s\d{6})$/:/(?:^|\s)(\d{4})$/,s.test(c)?(n.preventDefault(),setTimeout(function(){return r.val(c+" "+i)})):s.test(c+i)?(n.preventDefault(),setTimeout(function(){return r.val(c+i+" ")})):void 0)},i=function(e){var n,r;return n=t(e.currentTarget),r=n.val(),8!==e.which||null!=n.prop("selectionStart")&&n.prop("selectionStart")!==r.length?void 0:/\d\s$/.test(r)?(e.preventDefault(),setTimeout(function(){return n.val(r.replace(/\d\s$/,""))})):/\s\d?$/.test(r)?(e.preventDefault(),setTimeout(function(){return n.val(r.replace(/\d$/,""))})):void 0},m=function(e){return setTimeout(function(){var n,r;return n=t(e.currentTarget),r=n.val(),r=g(r),r=t.payment.formatExpiry(r),k(r,n)})},u=function(e){var n,r,a;return r=String.fromCharCode(e.which),/^\d+$/.test(r)?(n=t(e.currentTarget),a=n.val()+r,/^\d$/.test(a)&&"0"!==a&&"1"!==a?(e.preventDefault(),setTimeout(function(){return n.val("0"+a+" / ")})):/^\d\d$/.test(a)?(e.preventDefault(),setTimeout(function(){return n.val(""+a+" / ")})):void 0):void 0},c=function(e){var n,r,a;return r=String.fromCharCode(e.which),/^\d+$/.test(r)?(n=t(e.currentTarget),a=n.val(),/^\d\d$/.test(a)?n.val(""+a+" / "):void 0):void 0},l=function(e){var n,r,a;return a=String.fromCharCode(e.which),"/"===a||" "===a?(n=t(e.currentTarget),r=n.val(),/^\d$/.test(r)&&"0"!==r?n.val("0"+r+" / "):void 0):void 0},o=function(e){var n,r;return n=t(e.currentTarget),r=n.val(),8!==e.which||null!=n.prop("selectionStart")&&n.prop("selectionStart")!==r.length?void 0:/\d\s\/\s$/.test(r)?(e.preventDefault(),setTimeout(function(){return n.val(r.replace(/\d\s\/\s$/,""))})):void 0},p=function(e){return setTimeout(function(){var n,r;return n=t(e.currentTarget),r=n.val(),r=g(r),r=r.replace(/\D/g,"").slice(0,4),k(r,n)})},b=function(t){var e;return t.metaKey||t.ctrlKey?!0:32===t.which?!1:0===t.which?!0:t.which<33?!0:(e=String.fromCharCode(t.which),!!/[\d\s]/.test(e))},C=function(n){var r,a,i,o;return r=t(n.currentTarget),i=String.fromCharCode(n.which),/^\d+$/.test(i)&&!h(r)?(o=(r.val()+i).replace(/\D/g,""),a=e(o),a?o.length<=a.length[a.length.length-1]:o.length<=16):void 0},$=function(e){var n,r,a;return n=t(e.currentTarget),r=String.fromCharCode(e.which),/^\d+$/.test(r)&&!h(n)?(a=n.val()+r,a=a.replace(/\D/g,""),a.length>6?!1:void 0):void 0},y=function(e){var n,r,a;return n=t(e.currentTarget),r=String.fromCharCode(e.which),/^\d+$/.test(r)&&!h(n)?(a=n.val()+r,a.length<=4):void 0},w=function(e){var n,a,i,o,s;return n=t(e.currentTarget),s=n.val(),o=t.payment.cardType(s)||"unknown",n.hasClass(o)?void 0:(a=function(){var t,e,n;for(n=[],t=0,e=r.length;e>t;t++)i=r[t],n.push(i.type);return n}(),n.removeClass("unknown"),n.removeClass(a.join(" ")),n.addClass(o),n.toggleClass("identified","unknown"!==o),n.trigger("payment.cardType",o))},t.payment.fn.formatCardCVC=function(){return this.on("keypress",b),this.on("keypress",y),this.on("paste",p),this.on("change",p),this.on("input",p),this},t.payment.fn.formatCardExpiry=function(){return this.on("keypress",b),this.on("keypress",$),this.on("keypress",u),this.on("keypress",l),this.on("keypress",c),this.on("keydown",o),this.on("change",m),this.on("input",m),this},t.payment.fn.formatCardNumber=function(){return this.on("keypress",b),this.on("keypress",C),this.on("keypress",s),this.on("keydown",i),this.on("keyup",w),this.on("paste",f),this.on("change",f),this.on("input",f),this.on("input",w),this},t.payment.fn.restrictNumeric=function(){return this.on("keypress",b),this.on("paste",v),this.on("change",v),this.on("input",v),this},t.payment.fn.cardExpiryVal=function(){return t.payment.cardExpiryVal(t(this).val())},t.payment.cardExpiryVal=function(t){var e,n,r,a;return a=t.split(/[\s\/]+/,2),e=a[0],r=a[1],2===(null!=r?r.length:void 0)&&/^\d+$/.test(r)&&(n=(new Date).getFullYear(),n=n.toString().slice(0,2),r=n+r),e=parseInt(e,10),r=parseInt(r,10),{month:e,year:r}},t.payment.validateCardNumber=function(t){var n,r;return t=(t+"").replace(/\s+|-/g,""),/^\d+$/.test(t)?(n=e(t),n?(r=t.length,_.call(n.length,r)>=0&&(n.luhn===!1||d(t))):!1):!1},t.payment.validateCardExpiry=function(e,n){var r,a,i;return"object"==typeof e&&"month"in e&&(i=e,e=i.month,n=i.year),e&&n?(e=t.trim(e),n=t.trim(n),/^\d+$/.test(e)&&/^\d+$/.test(n)&&e>=1&&12>=e?(2===n.length&&(n=70>n?"20"+n:"19"+n),4!==n.length?!1:(a=new Date(n,e),r=new Date,a.setMonth(a.getMonth()-1),a.setMonth(a.getMonth()+1,1),a>r)):!1):!1},t.payment.validateCardCVC=function(e,r){var a,i;return e=t.trim(e),/^\d+$/.test(e)?(a=n(r),null!=a?(i=e.length,_.call(a.cvcLength,i)>=0):e.length>=3&&e.length<=4):!1},t.payment.cardType=function(t){var n;return t?(null!=(n=e(t))?n.type:void 0)||null:null},t.payment.formatCardNumber=function(n){var r,a,i,o;return n=n.replace(/\D/g,""),(r=e(n))?(i=r.length[r.length.length-1],n=n.slice(0,i),r.format.global?null!=(o=n.match(r.format))?o.join(" "):void 0:(a=r.format.exec(n),null!=a?(a.shift(),a=t.grep(a,function(t){return t}),a.join(" ")):void 0)):n},t.payment.formatExpiry=function(t){var e,n,r,a;return(n=t.match(/^\D*(\d{1,2})(\D+)?(\d{1,4})?/))?(e=n[1]||"",r=n[2]||"",a=n[3]||"",a.length>0?r=" / ":" /"===r?(e=e.substring(0,1),r=""):2===e.length||r.length>0?r=" / ":1===e.length&&"0"!==e&&"1"!==e&&(e="0"+e,r=" / "),e+r+a):""}}).call(this),function(){null==CakeCouponBook.validations&&(CakeCouponBook.validations={}),CakeCouponBook.validations.customMethods=function(){$.validator.addMethod("onlyletters",function(t,e){return this.optional(e)||/^[a-z\s]+$/i.test(t)},function(){return"Please enter only letters."}),$.validator.addMethod("url",function(t,e){return this.optional(e)||/^(?:(?:https?|ftp):\/\/)?(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/\S*)?$/i.test(t)},function(){return"Please enter a valid URL."}),$.validator.addMethod("minStrictPledgeLevels",function(t,e){var n;return n=$(e).closest(".pledge_level").find(".min_value").text().replace("$","").replace(",",""),this.optional(e)||parseInt(t)>parseInt(n)},function(t,e){var n;return n=$(e).closest(".pledge_level").find(".min_value").text().replace("$",""),"Please enter a value greater than $"+n}),$.validator.addMethod("limitToIntegerRange",function(t,e){return this.optional(e)||parseInt(t)<9999999999},function(){return"Please enter a value smaller than $9999999999"}),$.validator.addMethod("minStrict",function(t,e,n){return this.optional(e)||parseInt(t)>parseInt(n)},jQuery.validator.format("Please enter a value greater than {0}")),$.validator.addMethod("minCurrency",function(t,e,n){return this.optional(e)||parseInt(t)>=parseInt(n)},jQuery.validator.format("Please enter a value greater than ${0}")),$.validator.addMethod("firstLastName",function(t,e){return this.optional(e)||/^\w+\s+\w+$/i.test(t)},function(){return"Please enter First and Last Name."}),$.validator.addMethod("creditcard",function(t,e){return this.optional(e)||$.payment.validateCardNumber(t)},function(){return"Please enter a valid Card Number."}),$.validator.addMethod("cvc",function(t,e,n){var r;return r=$.payment.cardType($(n).val()),this.optional(e)||$.payment.validateCardCVC(t,r)},function(){return"The CVC number is incorrect."})}}.call(this),function(){var t,e;null==CakeCouponBook.purchases&&(CakeCouponBook.purchases={}),e=function(){function t(t){this.loadScript(t)}return t.prototype.loadScript=function(t){var e,n;void 0===window.Stripe&&(n=document.createElement("script"),n.async=!0,n.src="https://js.stripe.com/v2/",n.type="text/javascript",n.onreadystatechange=function(){"complete"===this.readyState&&window.Stripe.setPublishableKey(t)},n.onload=function(){window.Stripe.setPublishableKey(t)},e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(n,e))},t}(),t=function(){function t(t,n,r){this.form=$(t),this.cardNumber=this.form.find("input#purchase_card_number"),this.expMonth=this.form.find("input#purchase_exp_month"),this.expYear=this.form.find("input#purchase_exp_year"),this.cvc=this.form.find("input#purchase_cvc"),this.cardLogos=this.form.find(".cards"),this.submitButton=this.form.find('input[type="submit"]'),this.cardTokenInput=this.form.find("input#purchase_card_token_input"),this.amount=n,this.stripeKey=r,this.stripe=new e(r),this.spinner=$("#overlay_loading"),this.setUp(),this.onSubmit()}return t.prototype.setUp=function(){$('[data-toggle="tooltip"]').tooltip(),CakeCouponBook.validations.customMethods(),this.validation(),this.formSetup()},t.prototype.formSetup=function(){this.cardNumber.payment("formatCardNumber"),this.cvc.payment("formatCardCVC"),this.form.find(".restrictToNumber").payment("restrictNumeric"),this.showCardLogo()},t.prototype.showCardLogo=function(){var t;t=this,this.cardNumber.keyup(function(){var e;e=$.payment.cardType(this.value),null===e?t.cardLogos.removeClass().addClass("cards"):t.cardLogos.removeClass().addClass("cards").addClass(e)})},t.prototype.onSubmit=function(){var t;t=this,this.submitButton.click(function(e){t.form.valid()&&(e.preventDefault(),t.disableForm(),t.createToken())})},t.prototype.createToken=function(){var t,n;n=this,void 0===window.Stripe&&new e(this.stripeKey),t={number:this.cardNumber.val().replace(/\s+/g,""),exp_month:this.expMonth.val(),exp_year:this.expYear.val(),cvc:this.cvc.val()},window.Stripe.card.createToken(t,function(t,e){var r;e.error?(n.form.find("#payment-errors").text(e.error.message).removeClass("hidden"),n.enableForm()):(r=e.id,n.cardTokenInput.val(r),n.removeInputNames(),n.form.get(0).submit())})},t.prototype.enableForm=function(){this.submitButton.prop("disabled",!1),this.form.find("fieldset").css("opacity",1),this.spinner.addClass("hidden")},t.prototype.disableForm=function(){this.submitButton.prop("disabled",!0),this.form.find("fieldset").css("opacity",.5),this.spinner.removeClass("hidden")},t.prototype.removeInputNames=function(){var t;t=this.form.find(".cc_inputs input"),t.each(function(){$(this).removeAttr("name")})},t.prototype.validation=function(){var t;t=this,this.form.validate({errorElement:"span",rules:{"purchase[amount]":{required:!0,minCurrency:t.amount},"purchase[first_name]":{required:!0,onlyletters:!0},"purchase[last_name]":{required:!0,onlyletters:!0},"purchase[zip_code]":{required:!0,minlength:5,maxlength:5},"purchase[email]":{required:!0},"purchase[email_confirmation]":{required:!0,equalTo:"#purchase_email"},"purchase[card_number]":{required:!0,creditcard:!0},"purchase[exp_month]":{required:!0,digits:!0,maxlength:2,range:[1,12]},"purchase[exp_year]":{required:!0,digits:!0,maxlength:2,range:[15,99]},"purchase[cvc]":{required:!0,cvc:"#purchase_card_number"},"purchase[gift_attributes][first_name]":{required:"#gift-checkbox:checked"},"purchase[gift_attributes][last_name]":{required:"#gift-checkbox:checked"},"purchase[gift_attributes][email]":{required:"#gift-checkbox:checked"},"purchase[gift_attributes][email_confirmation]":{required:"#gift-checkbox:checked",equalTo:"#purchase_gift_attributes_email"}}})},t}(),CakeCouponBook.purchases.coupon_book=function(e,n){new t(".formtastic.purchase",e,n)}}.call(this);